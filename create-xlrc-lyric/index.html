<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LRC Lyric Translator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .upload-section {
            background: #f8f9fa;
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #764ba2;
            background: #f0f0ff;
        }

        .upload-section.dragging {
            border-color: #764ba2;
            background: #e8e8ff;
        }

        .file-input {
            display: none;
        }

        .upload-icon {
            font-size: 3em;
            color: #667eea;
            margin-bottom: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: transform 0.2s ease;
            margin: 10px 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .results-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .lyric-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            min-height: 400px;
        }

        .lyric-panel h2 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .lyric-content {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error {
            background: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }

        .error.active {
            display: block;
        }

        .info {
            background: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .results-container {
                grid-template-columns: 1fr;
            }

            header h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>üéµ Chinese LRC Lyric Translator</h1>
            <p>Translate your .lrc lyric files in Chinese to Pinyin and English instantly</p>
        </header>

        <div class="main-content">
            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">üìÅ</div>
                <h3>Click to select or drag & drop your .lrc file</h3>
                <p style="margin-top: 10px; color: #666;">Supports .lrc lyric format</p>
                <input type="file" id="fileInput" class="file-input" accept=".lrc,.txt">
            </div>

            <div class="error" id="errorMessage"></div>

            <div class="controls">
                <button class="btn" id="translateBtn" disabled>Translate to English</button>
                <button class="btn" id="pinyinBtn" disabled>Translate to Pinyin</button>
                <button class="btn" id="bothBtn" disabled>Translate to Pinyin + English</button>
                <button class="btn" id="downloadBtn" disabled>Download Translation</button>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Translating lyrics...</p>
            </div>

            <div class="results-container" id="resultsContainer" style="display: none;">
                <div class="lyric-panel">
                    <h2>Original Lyrics</h2>
                    <div class="lyric-content" id="originalLyrics"></div>
                </div>
                <div class="lyric-panel">
                    <h2 id="resultTitle">Result</h2>
                    <div class="lyric-content" id="resultLyrics"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pinyin-pro/3.27.0/index.min.js"
        integrity="sha512-aE0DCH0yU7dYVnse3UBrM68g/oMZl8nhjoCYXfYxZbEOi31MHnzMGR0Kbv9CBvZEz0sSn2J7i5EngSVhrbxJig=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        let originalLyricData = [];
        let translatedLyricData = [];
        let currentResultLines = [];
        let currentDownloadSuffix = '_english.lrc';
        let fileName = '';

        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');
        const translateBtn = document.getElementById('translateBtn');
        const pinyinBtn = document.getElementById('pinyinBtn');
        const bothBtn = document.getElementById('bothBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const loading = document.getElementById('loading');
        const loadingText = loading.querySelector('p');
        const defaultLoadingMessage = loadingText.textContent;
        const errorMessage = document.getElementById('errorMessage');
        const resultsContainer = document.getElementById('resultsContainer');
        const originalLyrics = document.getElementById('originalLyrics');
        const resultTitle = document.getElementById('resultTitle');
        const resultLyrics = document.getElementById('resultLyrics');

        // File upload handlers
        uploadSection.addEventListener('click', () => fileInput.click());

        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragging');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragging');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragging');
            const file = e.dataTransfer.files[0];
            handleFile(file);
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            handleFile(file);
        });

        function handleFile(file) {
            if (!file) return;

            if (!file.name.endsWith('.lrc') && !file.name.endsWith('.txt')) {
                showError('Please select a .lrc or .txt file');
                return;
            }

            fileName = file.name;
            const reader = new FileReader();

            reader.onload = (e) => {
                const content = e.target.result;
                parseLrcFile(content);
                translateBtn.disabled = false;
                pinyinBtn.disabled = false;
                bothBtn.disabled = false;
                uploadSection.innerHTML = `
                    <div class="upload-icon">‚úì</div>
                    <h3>${file.name}</h3>
                    <p style="margin-top: 10px; color: #666;">File loaded successfully. Click "Translate" to continue.</p>
                `;
            };

            reader.onerror = () => {
                showError('Error reading file');
            };

            reader.readAsText(file);
        }

        function parseLrcFile(content) {
            const lines = content.split('\n');
            originalLyricData = [];

            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (!trimmedLine) return;

                // Match LRC format: [00:00.00]lyric text
                const match = trimmedLine.match(/^(\[[\d:.]+\])(.*)/);

                if (match) {
                    originalLyricData.push({
                        timestamp: match[1],
                        text: match[2].trim()
                    });
                } else {
                    // Metadata or non-timestamped line
                    originalLyricData.push({
                        timestamp: '',
                        text: trimmedLine
                    });
                }
            });

            displayOriginalLyrics();
        }

        function displayOriginalLyrics() {
            originalLyrics.textContent = originalLyricData
                .map(line => line.timestamp + line.text)
                .join('\n');
            resultsContainer.style.display = 'grid';
        }

        // Translate button handler
        translateBtn.addEventListener('click', async () => {
            await translateLyrics();
        });

        // Pinyin button handler
        pinyinBtn.addEventListener('click', async () => {
            await translateToPinyin();
        });

        // Pinyin + English button handler
        bothBtn.addEventListener('click', async () => {
            await translateToPinyinAndEnglish();
        });

        async function translateLyrics() {
            loading.classList.add('active');
            translateBtn.disabled = true;
            errorMessage.classList.remove('active');
            translatedLyricData = [];
            resultTitle.textContent = 'English Translation';
            currentDownloadSuffix = '_english.lrc';

            try {
                // Extract only the lyric text (not timestamps or metadata)
                const textsToTranslate = originalLyricData
                    .map(line => line.text)
                    .filter(text => text.length > 0);

                // Translate in batches to avoid rate limits
                const batchSize = 10;
                const translations = [];

                for (let i = 0; i < textsToTranslate.length; i += batchSize) {
                    const batch = textsToTranslate.slice(i, i + batchSize);
                    const batchTranslations = await Promise.all(
                        batch.map(text => translateText(text))
                    );
                    translations.push(...batchTranslations);

                    // Small delay between batches
                    if (i + batchSize < textsToTranslate.length) {
                        await delay(500);
                    }
                }

                // Rebuild the lyric structure with translations
                let translationIndex = 0;
                originalLyricData.forEach(line => {
                    if (line.text.length > 0) {
                        translatedLyricData.push({
                            timestamp: line.timestamp,
                            text: translations[translationIndex] || line.text
                        });
                        translationIndex++;
                    } else {
                        translatedLyricData.push({
                            timestamp: line.timestamp,
                            text: ''
                        });
                    }
                });

                displayTranslatedLyrics();
                downloadBtn.disabled = false;

            } catch (error) {
                showError('Translation failed: ' + error.message);
            } finally {
                loading.classList.remove('active');
                translateBtn.disabled = false;
            }
        }

        async function translateText(text) {
            // Using Google Translate API (via MyMemory Translation API as a free alternative)
            // For production, you should use official Google Translate API with API key

            const encodedText = encodeURIComponent(text);
            const url = `https://api.mymemory.translated.net/get?q=${encodedText}&langpair=zh|en`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.responseStatus === 200 && data.responseData) {
                    return data.responseData.translatedText;
                } else {
                    throw new Error('Translation service error');
                }
            } catch (error) {
                console.error('Translation error:', error);
                return text; // Return original text if translation fails
            }
        }

        function displayTranslatedLyrics() {
            currentResultLines = translatedLyricData
                .map(line => line.timestamp + line.text);
            resultLyrics.textContent = currentResultLines.join('\n');
        }

        function getPinyinFn() {
            return window.pinyinPro && window.pinyinPro.pinyin;
        }

        function convertToPinyin(text) {
            const pinyinFn = getPinyinFn();
            return pinyinFn(text, {
                toneType: 'mark',
                type: 'string',
                nonZh: 'spaced'
            });
        }

        async function fetchEnglishTranslations() {
            const textsToTranslate = originalLyricData
                .map(line => line.text)
                .filter(text => text.length > 0);

            const batchSize = 10;
            const translations = [];

            for (let i = 0; i < textsToTranslate.length; i += batchSize) {
                const batch = textsToTranslate.slice(i, i + batchSize);
                const batchTranslations = await Promise.all(
                    batch.map(text => translateText(text))
                );
                translations.push(...batchTranslations);

                if (i + batchSize < textsToTranslate.length) {
                    await delay(500);
                }
            }
            return translations;
        }

        function displayResult(resultLines) {
            currentResultLines = resultLines;
            resultLyrics.textContent = currentResultLines.join('\n');
            resultsContainer.style.display = 'grid';
        }

        async function translateToPinyin() {
            if (!getPinyinFn()) {
                showError('Pinyin library not loaded. Please check your connection.');
                return;
            }

            resultTitle.textContent = 'Chinese + Pinyin';
            currentDownloadSuffix = '-cn-py.xlrc';
            loadingText.textContent = 'Converting to pinyin...';
            loading.classList.add('active');

            try {
                const resultLines = [];
                originalLyricData.forEach(line => {
                    const chineseLine = (line.timestamp || '') + line.text;
                    resultLines.push(chineseLine);

                    if (line.text) {
                        const pinyinLine = convertToPinyin(line.text);
                        resultLines.push(`[tran1]${pinyinLine}`);
                    }
                });

                displayResult(resultLines);
                downloadBtn.disabled = false;
            } catch (error) {
                showError('Pinyin conversion failed: ' + error.message);
            } finally {
                loading.classList.remove('active');
                loadingText.textContent = defaultLoadingMessage;
            }
        }

        async function translateToPinyinAndEnglish() {
            if (!getPinyinFn()) {
                showError('Pinyin library not loaded. Please check your connection.');
                return;
            }

            resultTitle.textContent = 'Chinese + Pinyin + English';
            currentDownloadSuffix = '-cn-py-en.xlrc';
            loadingText.textContent = 'Converting to pinyin + English...';
            loading.classList.add('active');
            errorMessage.classList.remove('active');

            try {
                const translations = await fetchEnglishTranslations();
                const resultLines = [];
                let translationIndex = 0;

                originalLyricData.forEach(line => {
                    const chineseLine = (line.timestamp || '') + line.text;
                    resultLines.push(chineseLine);

                    if (line.text) {
                        const pinyinLine = convertToPinyin(line.text);
                        resultLines.push(`[tran1]${pinyinLine}`);

                        const englishLine = translations[translationIndex] || line.text;
                        resultLines.push(`[tran2]${englishLine}`);
                        translationIndex++;
                    }
                });

                displayResult(resultLines);
                downloadBtn.disabled = false;
            } catch (error) {
                showError('Combined translation failed: ' + error.message);
            } finally {
                loading.classList.remove('active');
                loadingText.textContent = defaultLoadingMessage;
            }
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Download button handler
        downloadBtn.addEventListener('click', () => {
            const content = currentResultLines.join('\n');

            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const baseName = fileName.replace(/\.[^.]+$/, '') || fileName;
            a.download = `${baseName}${currentDownloadSuffix}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('active');
            setTimeout(() => {
                errorMessage.classList.remove('active');
            }, 5000);
        }
    </script>
</body>

</html>